from script.cryptohack.elliptic_curve import *

def microexponent_revenge():
    a = 1
    b = 7
    p = 81663996540811672901764249733343363790991183353803305739092974199965546219729
    Gxy = (14023374736200111073976017545954000619736741127496973904317708826835398305431, 23173384182409394365116200040829680541979866476670477159886520495530923549144)
    Pxy = (63698676086974127123544556591037049117285370657094973402459055228534678256540, 50054613692038253008132268195064761802561717815733137655094406841864102707369)
    ciphertext = bytes.fromhex('701d3fed9cf7f5182f2e924ed9f9d23a9a0bf21ac6bf877bb53f6ceb27ae86551df3f27d8820c4bd2552f4953406ba18')
    iv = bytes.fromhex('8d79f0db12f8d54f2fd70d067340124f')
    
    curve = EC(p, a, b)
    G = PointEC(curve, *Gxy)
    P = PointEC(curve, *Pxy)
    
    n = order(G, p) 
    primes_factor = get_prime_factor(n)
    print(n, primes_factor)
    
    PRIVATE_KEY_BIT_SIZE = 64
    biggest_prime = max(primes_factor.keys())
    print(f"Biggest prime bit count: {biggest_prime.bit_count()}")
    subgroup_order = 1
    for prime, exp in primes_factor.items():
        new_order = subgroup_order * pow(prime,exp)
        if new_order.bit_count() >= PRIVATE_KEY_BIT_SIZE:
            print("Found enough factors! The rest are not needed")
            break
        subgroup_order = new_order
    
    
    x = pohlig_hellman(G, P, p, known_order=subgroup_order)
    if not x:
        return None
    # Now that we found x such that small_order_G * x = small_order_P
    # Recall that x = key (mod subgroup_order)
    # while key lie somehere in order n
    
    assert x * G == P
    
    sha1 = hashlib.sha1()
    sha1.update(str(x).encode('ascii'))
    key = sha1.digest()[:16]
    cipher = AES.new(key, AES.MODE_CBC, iv=iv)
    plaintext = cipher.decrypt(ciphertext)
    
    return plaintext

def rsa_with_a_hint():
    N = 71265414408164782724799236183731184290483454935475567996082990232753834738522591618102393925219210035328522314373360695452360029719577627759990866649971936124535888856570135200008810318772247262796703223061238662374143334655920441589813687052362510749486735082413500690349387534377197208335977650307181777949
    e = 65537
    c = 19940010393828927021006982579772211764096780139150134709306565250242961073654540995470785720199848358036764678161244159988392712774059527857798841620117016534366770399280043027665253489263519835038098245129628021622657203912628499548103565647876777005356049009573810952832558629289705804739902477471385578195
    hint = 1314141272880369748987070958975014964732456047160084498406826910367390908235849010823263035635913130647884562589457527592409825368792501912617286577577052

    # p - q = hint =>